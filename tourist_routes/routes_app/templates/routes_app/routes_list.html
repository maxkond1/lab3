{% extends 'routes_app/base.html' %}

{% block content %}
<h1>–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã</h1>

<!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö -->
<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
    <form method="get" style="display: flex; gap: 15px; align-items: center;">
        <label>
            <strong>–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:</strong>
            <select name="source" onchange="this.form.submit()">
                <option value="db" {% if source == 'db' %}selected{% endif %}>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</option>
                <option value="xml" {% if source == 'xml' %}selected{% endif %}>XML —Ñ–∞–π–ª</option>
            </select>
        </label>
        
        {% if source == 'db' %}
        <label>
            <strong>–û–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫:</strong>
            <input type="text" name="search" value="{{ search_query }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –æ–ø–∏—Å–∞–Ω–∏—é..." style="margin-left: 10px;">
            <button type="submit">–ù–∞–π—Ç–∏</button>
        </label>
        {% elif source == 'xml' %}
        <label>
            <strong>–ü–æ–∏—Å–∫ –≤ XML:</strong>
            <input type="text" name="search" value="{{ search_query }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –æ–ø–∏—Å–∞–Ω–∏—é..." style="margin-left: 10px;">
            <button type="submit">–ù–∞–π—Ç–∏</button>
        </label>
        {% endif %}
    </form>
</div>

<!-- AJAX –ø–æ–∏—Å–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ë–î) -->
{% if source == 'db' %}
<div style="margin-bottom: 30px; padding: 20px; background: #e9f7fe; border-radius: 8px; border: 1px solid #b3e0ff;">
    <h3 style="margin-top: 0; color: #0066cc;">üîç AJAX –ü–æ–∏—Å–∫ (–∂–∏–≤–æ–π –ø–æ–∏—Å–∫)</h3>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="ajax-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ä–µ–≥–∏–æ–Ω, –æ–ø–∏—Å–∞–Ω–∏–µ..." 
               style="flex: 1; padding: 12px; border: 2px solid #007bff; border-radius: 6px; font-size: 16px;">
        <div id="search-status" style="color: #666; font-size: 14px;"></div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã AJAX –ø–æ–∏—Å–∫–∞ -->
    <div id="ajax-results" style="margin-top: 15px; display: none;">
        <div id="search-results" style="border: 1px solid #ddd; border-radius: 6px; background: white; max-height: 400px; overflow-y: auto;"></div>
    </div>
</div>
{% endif %}

{% if source == 'db' %}
    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏–∑ –ë–î -->
    {% if routes %}
    <h3>–ú–∞—Ä—à—Ä—É—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ({{ routes|length }})</h3>
    <table>
        <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–†–µ–≥–∏–æ–Ω</th>
                <th>–ü—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å (–∫–º)</th>
                <th>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π)</th>
                <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                <th>–õ—É—á—à–µ–µ –≤—Ä–µ–º—è</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for route in routes %}
            <tr>
                <td><strong>{{ route.name }}</strong></td>
                <td>{{ route.region }}</td>
                <td>{{ route.length_km }}</td>
                <td>{{ route.duration_days }}</td>
                <td>{{ route.get_difficulty_display }}</td>
                <td>{{ route.best_season }}</td>
                <td>{{ route.kolvo_chel }}</td>
                <td>
                    <a href="{% url 'edit_route' route.id %}" style="color: #007bff;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a> |
                    <a href="{% url 'delete_route' route.id %}" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç \"{{ route.name }}\"?')" style="color: #dc3545;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #666;">
        <h3>üì≠ –ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</h3>
        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –º–∞—Ä—à—Ä—É—Ç —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</p>
    </div>
    {% endif %}

{% else %}
    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏–∑ XML -->
    {% if xml_routes %}
    <h3>–ú–∞—Ä—à—Ä—É—Ç—ã –∏–∑ XML —Ñ–∞–π–ª–∞ ({{ xml_routes|length }})</h3>
    <table>
        <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–†–µ–≥–∏–æ–Ω</th>
                <th>–ü—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å (–∫–º)</th>
                <th>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π)</th>
                <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                <th>–õ—É—á—à–µ–µ –≤—Ä–µ–º—è</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫</th>
                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for route in xml_routes %}
            <tr>
                <td><strong>{{ route.name }}</strong></td>
                <td>{{ route.region }}</td>
                <td>{{ route.length_km }}</td>
                <td>{{ route.duration_days }}</td>
                <td>{{ route.difficulty }}</td>
                <td>{{ route.best_season }}</td>
                <td>{{ route.kolvo_chel }}</td>
                <td>{{ route.created_at|slice:":10" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #666;">
        <h3>üì≠ –ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤ XML —Ñ–∞–π–ª–µ</h3>
        <p>–î–æ–±–∞–≤—å—Ç–µ –º–∞—Ä—à—Ä—É—Ç—ã —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ XML —Ñ–∞–π–ª</p>
    </div>
    {% endif %}
{% endif %}

<!-- AJAX –ø–æ–∏—Å–∫ JavaScript -->
{% if source == 'db' %}
<script>
let searchTimeout;

document.getElementById('ajax-search').addEventListener('input', function() {
    const query = this.value.trim();
    const statusElement = document.getElementById('search-status');
    const resultsContainer = document.getElementById('search-results');
    const ajaxResults = document.getElementById('ajax-results');
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
    clearTimeout(searchTimeout);
    
    if (query.length === 0) {
        statusElement.textContent = '';
        ajaxResults.style.display = 'none';
        return;
    }
    
    if (query.length < 2) {
        statusElement.textContent = '–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞';
        ajaxResults.style.display = 'none';
        return;
    }
    
    statusElement.textContent = '‚åõ –ü–æ–∏—Å–∫...';
    ajaxResults.style.display = 'block';
    resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">‚åõ –ü–æ–∏—Å–∫...</div>';
    
    // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞ (–¥–µ–±–∞—É–Ω—Å)
    searchTimeout = setTimeout(() => {
        fetch(`{% url 'ajax_search' %}?q=${encodeURIComponent(query)}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                statusElement.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞';
                resultsContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545;">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                return;
            }
            
            statusElement.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ: ${data.count} –º–∞—Ä—à—Ä—É—Ç–æ–≤`;
            
            if (data.results.length > 0) {
                resultsContainer.innerHTML = data.results.map(route => `
                    <div style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;" 
                         onmouseover="this.style.background='#f8f9fa'" 
                         onmouseout="this.style.background='white'"
                         onclick="window.location.href='{% url 'routes_list' %}?source=db&search=${encodeURIComponent(route.name)}'">
                        <div style="display: flex; justify-content: between; align-items: start;">
                            <div style="flex: 1;">
                                <strong style="color: #007bff; font-size: 16px;">${route.name}</strong>
                                <div style="color: #28a745; font-size: 14px; margin-top: 5px;">üìç ${route.region}</div>
                                <div style="color: #666; font-size: 13px; margin-top: 5px;">${route.description}</div>
                                <div style="margin-top: 8px; font-size: 12px; color: #888;">
                                    üìè ${route.length_km} –∫–º | ‚è±Ô∏è ${route.duration_days} –¥–Ω–µ–π | üèîÔ∏è ${route.difficulty} | üå§Ô∏è ${route.best_season}
                                </div>
                            </div>
                            <div style="margin-left: 15px;">
                                <a href="{% url 'edit_route' 0 %}".replace('0', route.id) 
                                   style="color: #007bff; text-decoration: none; font-size: 12px;">‚úèÔ∏è</a>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                resultsContainer.innerHTML = `
                    <div style="padding: 30px; text-align: center; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
                        <h4>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            statusElement.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</div>';
        });
    }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300ms
});

// –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–∏—Å–∫–∞
document.addEventListener('click', function(e) {
    if (!e.target.closest('#ajax-search') && !e.target.closest('#ajax-results')) {
        document.getElementById('ajax-results').style.display = 'none';
        document.getElementById('search-status').textContent = '';
    }
});

// –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Ctrl+K
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('ajax-search').focus();
    }
});

// –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É
document.getElementById('ajax-search').placeholder = "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ä–µ–≥–∏–æ–Ω, –æ–ø–∏—Å–∞–Ω–∏–µ... ";
</script>
{% endif %}
{% endblock %}